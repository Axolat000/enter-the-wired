#!/bin/bash
set -euo pipefail

# ENTER THE WIRED â€“ Combo Installer
# ACCELA (ciscosweater) + SLSsteam (Axolat000 via git)

GITHUB_USER="ciscosweater"
GITHUB_REPO="enter-the-wired"

SLS_REPO_URL="https://github.com/Axolat000/enter-the-wired"
SLS_REPO_DIR="enter-the-wired"
SLS_SUBDIR="SLSsteam-Any"

# -------------------------------------------------
# Detect curl | bash
# -------------------------------------------------
RUNNING_VIA_PIPE=false
if [ -z "${BASH_SOURCE:-}" ] || [[ "${BASH_SOURCE[0]:-}" == "-" ]]; then
    RUNNING_VIA_PIPE=true
fi

# -------------------------------------------------
# Colors
# -------------------------------------------------
if [ -t 1 ] && [ -t 0 ]; then
    GREEN='\033[0;32m'
    RED='\033[0;31m'
    YELLOW='\033[1;33m'
    NC='\033[0m'
else
    GREEN='' RED='' YELLOW='' NC=''
fi

# -------------------------------------------------
# Ensure git is installed
# -------------------------------------------------
ensure_git() {
    if command -v git >/dev/null 2>&1; then
        return
    fi

    echo -e "${YELLOW}git not found, installing...${NC}"

    if command -v apt >/dev/null 2>&1; then
        sudo apt update
        sudo apt install -y git
    elif command -v pacman >/dev/null 2>&1; then
        sudo pacman -Sy --noconfirm git
    elif command -v dnf >/dev/null 2>&1; then
        sudo dnf install -y git
    else
        echo -e "${RED}No supported package manager found. Install git manually.${NC}"
        exit 1
    fi
}

# -------------------------------------------------
# Prepare workspace
# -------------------------------------------------
if [ "$RUNNING_VIA_PIPE" = true ]; then
    SCRIPT_DIR="$(mktemp -d)"
    trap "rm -rf $SCRIPT_DIR" EXIT

    cd "$SCRIPT_DIR"

    echo -e "${GREEN}Fetching ACCELA repo...${NC}"
    git clone "https://github.com/$GITHUB_USER/$GITHUB_REPO"
    cd "$GITHUB_REPO"
else
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    cd "$SCRIPT_DIR"
fi

# -------------------------------------------------
# Load ACCELA
# -------------------------------------------------
if [ ! -f "accela" ]; then
    echo -e "${RED}Error: accela not found in $PWD${NC}"
    exit 1
fi

chmod +x accela
source "./accela"

# -------------------------------------------------
# Clone SLSsteam repo
# -------------------------------------------------
ensure_git

if [ ! -d "$SLS_REPO_DIR" ]; then
    echo -e "${GREEN}Cloning SLSsteam repository...${NC}"
    git clone "$SLS_REPO_URL"
else
    echo -e "${YELLOW}SLSsteam repo already exists, skipping clone.${NC}"
fi

# -------------------------------------------------
# Run installers
# -------------------------------------------------
echo -e "${GREEN}=============================================="
echo "  ENTER THE WIRED - Combo Installer"
echo "==============================================${NC}"
echo ""

echo "Installing ACCELA..."
echo "----------------------------------------------"
install_accela

echo ""
echo "Installing SLSsteam..."
echo "----------------------------------------------"

cd "$SLS_REPO_DIR/$SLS_SUBDIR"

chmod +x setup.sh
./setup.sh

echo ""
echo -e "${GREEN}=============================================="
echo "  ALL INSTALLATIONS COMPLETED!"
echo "==============================================${NC}"
echo ""
echo "Protocol complete. Welcome to the Wired."
