#!/bin/bash
set -euo pipefail

# =================================================
# ENTER THE WIRED ‚Äî INSTALLATEUR COMBO
# ACCELA (ciscosweater) + SLSsteam (Axolat000)
# =================================================

ACCELA_USER="ciscosweater"
ACCELA_REPO="enter-the-wired"

SLS_REPO_URL="https://github.com/Axolat000/enter-the-wired"
SLS_REPO_DIR="deps/slssteam"
SLS_SUBDIR="SLSsteam-Any"

# -------------------------------------------------
# D√©tection curl | bash
# -------------------------------------------------
RUNNING_VIA_PIPE=false
if [ -z "${BASH_SOURCE:-}" ] || [[ "${BASH_SOURCE[0]:-}" == "-" ]]; then
    RUNNING_VIA_PIPE=true
fi

# -------------------------------------------------
# Couleurs
# -------------------------------------------------
if [ -t 1 ] && [ -t 0 ]; then
    GREEN='\033[0;32m'
    RED='\033[0;31m'
    YELLOW='\033[1;33m'
    NC='\033[0m'
else
    GREEN='' RED='' YELLOW='' NC=''
fi

# -------------------------------------------------
# V√©rification / installation de git
# -------------------------------------------------
ensure_git() {
    if command -v git >/dev/null 2>&1; then
        return
    fi

    echo -e "${YELLOW}git non install√©, installation en cours...${NC}"

    if command -v apt >/dev/null 2>&1; then
        sudo apt update
        sudo apt install -y git
    elif command -v pacman >/dev/null 2>&1; then
        sudo pacman -Sy --noconfirm git
    elif command -v dnf >/dev/null 2>&1; then
        sudo dnf install -y git
    else
        echo -e "${RED}Gestionnaire de paquets non support√©. Installe git manuellement.${NC}"
        exit 1
    fi
}

# -------------------------------------------------
# Pr√©paration du dossier de travail
# -------------------------------------------------
if [ "$RUNNING_VIA_PIPE" = true ]; then
    WORKDIR="$(mktemp -d)"
    trap "rm -rf $WORKDIR" EXIT
    cd "$WORKDIR"

    echo -e "${GREEN}R√©cup√©ration du d√©p√¥t ACCELA...${NC}"
    git clone "https://github.com/$ACCELA_USER/$ACCELA_REPO"
    cd "$ACCELA_REPO"
else
    WORKDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    cd "$WORKDIR"
fi

# -------------------------------------------------
# Chargement ACCELA
# -------------------------------------------------
if [ ! -f "accela" ]; then
    echo -e "${RED}Erreur : script accela introuvable.${NC}"
    exit 1
fi

chmod +x accela
source "./accela"

# -------------------------------------------------
# Clone / mise √† jour SLSsteam
# -------------------------------------------------
ensure_git
mkdir -p deps

if [ ! -d "$SLS_REPO_DIR/.git" ]; then
    echo -e "${GREEN}Clonage du d√©p√¥t SLSsteam...${NC}"
    git clone "$SLS_REPO_URL" "$SLS_REPO_DIR"
else
    echo -e "${YELLOW}D√©p√¥t SLSsteam d√©j√† pr√©sent, mise √† jour...${NC}"
    git -C "$SLS_REPO_DIR" pull --ff-only
fi

# -------------------------------------------------
# Installation
# -------------------------------------------------
echo -e "${GREEN}=============================================="
echo "  ENTER THE WIRED ‚Äî INSTALLATEUR"
echo "==============================================${NC}"
echo ""

echo "üì¶ Installation de ACCELA..."
echo "----------------------------------------------"
install_accela

echo ""
echo "üéÆ Installation de SLSsteam..."
echo "----------------------------------------------"

cd "$SLS_REPO_DIR/$SLS_SUBDIR"

if [ ! -f "setup.sh" ]; then
    echo -e "${RED}Erreur : setup.sh introuvable dans SLSsteam-Any${NC}"
    exit 1
fi

chmod +x setup.sh
./setup.sh install

# -------------------------------------------------
# Fin
# -------------------------------------------------
echo ""
echo -e "${GREEN}=============================================="
echo "  INSTALLATION TERMIN√âE AVEC SUCC√àS"
echo "==============================================${NC}"
echo ""

echo "üìç R√©sum√© :"
echo " ‚Ä¢ ACCELA install√© dans : ~/.local/share/ACCELA"
echo " ‚Ä¢ SLSsteam install√© dans : ~/.local/share/SLSsteam"
echo ""

echo "üéÆ Red√©marre Steam pour activer SLSsteam."
echo ""
echo "Protocole termin√©. Bienvenue dans le Wired."
